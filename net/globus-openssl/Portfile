# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

# $Id$

if {$build_arch == "x86_64" || $build_arch == "ppc64"} {
    set flavor gcc64pthr
} else {
    set flavor gcc32pthr
}

PortSystem              1.0

name                    globus-openssl
set _name               [ string map {"-" "_"} $name ]
version                 5.0
revision                1
platforms               darwin
categories              net
license                 Apache 2.0
maintainers             fysast.uu.se:mattias.ellert nbi.ku.dk:skou
homepage                http://www.globus.org/

description             Globus Toolkit - Openssl Library
long_description        The Globus Toolkit is an open source software \
                        toolkit used for building Grid systems and \
                        applications. It is being developed by the \
                        Globus Alliance and many others all over the \
                        world. A growing number of projects and \
                        companies are using the Globus Toolkit to \
                        unlock the potential of grids for their \
                        cause. The ${name} package contains: \
                        Openssl Library (virtual GPT glue package)

distfiles               ${name}-pkg_data_src.gpt.in

depends_run             port:openssl

depends_build           port:grid-packaging-tools \
                        port:globus-core \
                        port:openssl

extract {
    file mkdir ${worksrcpath}
    copy ${filespath}/${name}-pkg_data_src.gpt.in \
        ${worksrcpath}/pkg_data_src.gpt
}

configure {
    set OPENSSL_VERSION [ exec pkg-config openssl --modversion ]
    set OPENSSL_INCLUDES [ exec pkg-config openssl --cflags ]
    set OPENSSL_LIBS [ exec pkg-config openssl --libs ]

    reinplace "s!@OPENSSL_VERSION@!${OPENSSL_VERSION}!g" \
        ${worksrcpath}/pkg_data_src.gpt
    reinplace "s!@OPENSSL_INCLUDES@!${OPENSSL_INCLUDES}!g" \
        ${worksrcpath}/pkg_data_src.gpt
    reinplace "s!@OPENSSL_LIBS@!${OPENSSL_LIBS}!g" \
        ${worksrcpath}/pkg_data_src.gpt
}

build {
    system "echo /share/globus/packages/${_name}/${flavor}_rtl.filelist > \
        ${worksrcpath}/${flavor}_rtl.filelist"
    system "echo /share/globus/packages/${_name}/pkg_data_${flavor}_rtl.gpt >> \
        ${worksrcpath}/${flavor}_rtl.filelist"

    system "echo /share/globus/packages/${_name}/${flavor}_pgm.filelist > \
        ${worksrcpath}/${flavor}_pgm.filelist"
    system "echo /share/globus/packages/${_name}/pkg_data_${flavor}_pgm.gpt >> \
        ${worksrcpath}/${flavor}_pgm.filelist"

    system "echo /share/globus/packages/${_name}/${flavor}_dev.filelist > \
        ${worksrcpath}/${flavor}_dev.filelist"
    system "echo /share/globus/packages/${_name}/pkg_data_${flavor}_dev.gpt >> \
        ${worksrcpath}/${flavor}_dev.filelist"

    system "cd ${worksrcpath} && ${prefix}/sbin/gpt_generate_bin_pkg_data \
        --flavor=${flavor} pkg_data_src.gpt"
}

destroot {
    set GLOBUSPACKAGEDIR ${destroot}${prefix}/share/globus/packages

    file mkdir ${GLOBUSPACKAGEDIR}/${_name}
    xinstall -m 644 ${worksrcpath}/pkg_data_${flavor}_rtl.gpt \
        ${worksrcpath}/${flavor}_rtl.filelist ${GLOBUSPACKAGEDIR}/${_name}
    xinstall -m 644 ${worksrcpath}/pkg_data_${flavor}_pgm.gpt \
        ${worksrcpath}/${flavor}_pgm.filelist ${GLOBUSPACKAGEDIR}/${_name}
    xinstall -m 644 ${worksrcpath}/pkg_data_${flavor}_dev.gpt \
        ${worksrcpath}/${flavor}_dev.filelist ${GLOBUSPACKAGEDIR}/${_name}

    # Generate pkg-config file from GPT metadata
    file mkdir ${destroot}${prefix}/lib/pkgconfig
    system "${prefix}/share/globus/globus-gpt2pkg-config \
        ${worksrcpath}/pkg_data_${flavor}_dev.gpt | \
        sed -e \"s/Requires:.*/Requires: openssl/\" \
            -e \"s/Cflags:.*/Cflags:/\" \
            -e \"s/Libs:.*/Libs:/\" > \
        ${destroot}${prefix}/lib/pkgconfig/${name}.pc"
}
